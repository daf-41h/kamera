<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Kamera Stok Opname</title>
<style>
 body { margin:0; font-family:Arial, sans-serif; background:#000; color:#fff; }
 video { width:100%; height:auto; }
 #controls { padding:10px; background:#111; }
 select, button { padding:10px; margin:5px 0; width:100%; border:none; border-radius:5px; }
 #preview { margin-top:10px; width:100%; }
 canvas { display:none; }
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>

<video id="video" autoplay playsinline></video>

<div id="controls">
 <select id="category">
  <option>Barang Sampai</option>
  <option>Bahan Sebelum Dicuci</option>
  <option>Sudah Dicuci</option>
  <option>Rusak / Busuk</option>
 </select>
 <button onclick="switchCamera()">Ganti Kamera</button>
 <button onclick="takePhoto()">Ambil Foto</button>
 <a id="downloadLink" download="hasil.jpg" style="display:none;"><button>Download Foto</button></a>
</div>

<img id="preview" />

<canvas id="canvas"></canvas>
<canvas id="mapCanvas" width="250" height="250"></canvas>

<script>
let useFront = false;
let video = document.getElementById("video");
let canvas = document.getElementById("canvas");
let preview = document.getElementById("preview");
let downloadLink = document.getElementById("downloadLink");
let mapCanvas = document.getElementById("mapCanvas");
let latitude, longitude;

async function startCamera(){
 let stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: useFront?"user":"environment" }});
 video.srcObject = stream;
}
startCamera();
function switchCamera(){ useFront=!useFront; startCamera(); }

navigator.geolocation.getCurrentPosition(pos=>{
 latitude = pos.coords.latitude;
 longitude = pos.coords.longitude;
 loadMap(latitude, longitude);
});

function loadMap(lat, lng){
 let map = L.map(mapCanvas,{center:[lat,lng],zoom:17,zoomControl:false,attributionControl:false});
 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
 L.marker([lat,lng]).addTo(map);
 setTimeout(()=>{ map.invalidateSize(); },400);
}

function takePhoto(){
 let w = video.videoWidth;
 let h = video.videoHeight;
 canvas.width = w;
 canvas.height = h;
 let ctx = canvas.getContext("2d");

 ctx.drawImage(video,0,0,w,h);
 ctx.drawImage(mapCanvas,20,20,220,220);

 let cat = document.getElementById("category").value;
 ctx.fillStyle = "rgba(0,0,0,0.55)";
 ctx.fillRect(w-300,30,260,55);
 ctx.fillStyle = "#fff";
 ctx.font = "32px Arial";
 ctx.fillText(cat, w-280,70);

 let now = new Date();
 let jam = now.toLocaleTimeString('id-ID',{hour:'2-digit',minute:'2-digit'});
 ctx.font = "70px Arial";
 ctx.fillText(jam, 40, h-260);

 ctx.font = "32px Arial";
 ctx.fillText(now.toLocaleDateString('id-ID',{weekday:'long',day:'2-digit',month:'2-digit',year:'numeric'}),40,h-210);

 ctx.font = "26px Arial";
 ctx.fillText(`Koordinat: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`,40,h-155);
 ctx.fillText(`Cuaca: 26Â°C`,40,h-120);

 let dataURL = canvas.toDataURL("image/jpeg",0.95);
 preview.src = dataURL;
 downloadLink.href = dataURL;
 downloadLink.style.display = "block";
}
</script>
</body>
</html>
