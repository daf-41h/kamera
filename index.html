<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Stok Opname - Timemark Style (Web)</title>
  <style>
    :root{--accent:#ffb703}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:#111827; color:#fff; display:flex; align-items:center; justify-content:center; min-height:100vh; margin:0}
    .app{width:420px; max-width:95vw; background:#0b1220; border-radius:12px; padding:14px; box-shadow:0 8px 30px rgba(2,6,23,.6)}
    video, canvas{width:100%; height:auto; border-radius:10px; background:#000}
    .controls{display:grid; grid-template-columns:1fr auto; gap:8px; margin-top:10px}
    select,input,button{padding:10px; border-radius:8px; border:0; font-size:14px}
    select,input{background:#0f1724; color:#fff}
    button{background:var(--accent); color:#000; font-weight:600; cursor:pointer}
    .controlsRow{display:flex; gap:8px; margin-top:10px}
    #previewArea{margin-top:12px}
  </style>
</head>
<body>
  <div class="app">
    <h3 style="margin:0 0 8px 0">Stok Opname â€” Timemark Style (Web)</h3>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" style="display:none"></canvas>

    <div class="controls">
      <select id="cameraSelect"></select>
      <button id="switchBtn">Ganti Kamera</button>
    </div>

    <div class="controlsRow">
      <select id="category">
        <option value="Barang Sampai">Barang Sampai</option>
        <option value="Bahan Sebelum Dicuci">Bahan Sebelum Dicuci</option>
        <option value="Sesudah Dicuci">Sesudah Dicuci</option>
        <option value="Bahan Busuk/Rusak">Bahan Busuk / Rusak</option>
      </select>
      <input id="note" placeholder="Keterangan tambahan" />
    </div>

    <div class="controlsRow">
      <button id="takeBtn">Ambil Foto</button>
      <button id="downloadBtn" style="display:none">Download</button>
    </div>

    <div id="previewArea"></div>
  </div>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const categoryEl = document.getElementById('category');
    const noteEl = document.getElementById('note');
    const previewArea = document.getElementById('previewArea');
    const downloadBtn = document.getElementById('downloadBtn');
    let lastPosition = null;
    let lastAddress = '';

    async function ensurePosition(){
      return new Promise((resolve)=>{
        navigator.geolocation.getCurrentPosition(async pos=>{
          lastPosition = pos.coords;
          try{
            const r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`);
            const j = await r.json();
            lastAddress = j.display_name || '';
          }catch(e){ lastAddress = 'Alamat tidak ditemukan'; }
          resolve();
        },()=>resolve());
      });
    }

    async function drawSnapshot(){
      await ensurePosition();
      const w = video.videoWidth;
      const h = video.videoHeight;
      canvas.width = w;
      canvas.height = h;
      const ctx = canvas.getContext('2d');

      ctx.drawImage(video,0,0,w,h);

      ctx.fillStyle = 'rgba(0,0,0,0.45)';
      ctx.fillRect(10, h-180, w-20, 170);

      const now = new Date();
      ctx.fillStyle='white';
      ctx.font = (w*0.07)+'px sans-serif';
      ctx.fillText(now.getHours().toString().padStart(2,'0')+":"+now.getMinutes().toString().padStart(2,'0'), 25, h-120);

      ctx.font = (w*0.035)+'px sans-serif';
      ctx.fillText(now.toLocaleDateString('id-ID',{weekday:'long'})+", "+now.toLocaleDateString('id-ID'), 25, h-85);

      ctx.font=(w*0.03)+'px sans-serif';
      ctx.fillText(`Koordinat: ${lastPosition?.latitude.toFixed(6)}, ${lastPosition?.longitude.toFixed(6)}`, 25, h-55);

      ctx.fillText(lastAddress, 25, h-25);

      ctx.fillStyle='rgba(0,0,0,0.5)';
      ctx.fillRect(w-250, 20, 230, 50);
      ctx.fillStyle='white';
      ctx.font=(w*0.03)+'px sans-serif';
      ctx.fillText(categoryEl.value, w-235, 55);

      if(noteEl.value){
        ctx.fillText('Ket: '+noteEl.value, w-235, 85);
      }

      const data = canvas.toDataURL('image/png');
      previewArea.innerHTML = `<img src="${data}" style="width:100%;margin-top:12px;border-radius:10px">`;
      downloadBtn.style.display='block';
    }

    takeBtn.addEventListener('click', drawSnapshot);
    downloadBtn.addEventListener('click', ()=>{
      const a=document.createElement('a');
      a.href=previewArea.querySelector('img').src;
      a.download='stok-opname.png';
      a.click();
    });

    navigator.mediaDevices.getUserMedia({video:true}).then(stream=>{
      video.srcObject=stream;
    });
  </script>
</body>
</html>
